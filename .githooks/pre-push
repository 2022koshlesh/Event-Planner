#!/bin/bash

# Pre-push hook for Event Planning Platform
# Runs linting and basic checks before allowing push

echo "ğŸ” Running pre-push checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any checks fail
CHECKS_FAILED=0

# Check if Python is available
if ! command -v python &> /dev/null; then
    echo -e "${RED}âŒ Python not found. Please install Python.${NC}"
    exit 1
fi

# Check if virtual environment is activated (optional but recommended)
if [[ -z "$VIRTUAL_ENV" ]]; then
    echo -e "${YELLOW}âš ï¸  Warning: Virtual environment not activated${NC}"
fi

# Get list of Python files in the repository (excluding venv, migrations, etc.)
PYTHON_FILES=$(git ls-files '*.py' | grep -v '^venv/' | grep -v '/migrations/' | grep -v '^env/')

if [ -z "$PYTHON_FILES" ]; then
    echo -e "${GREEN}âœ“ No Python files to check${NC}"
    exit 0
fi

echo -e "${YELLOW}Checking all Python files in repository...${NC}"

# Run flake8 if available
if command -v flake8 &> /dev/null; then
    echo -e "\n${YELLOW}Running flake8...${NC}"
    echo "$PYTHON_FILES" | xargs flake8 --max-line-length=120
    if [ $? -ne 0 ]; then
        echo -e "${RED}âŒ Flake8 found linting errors${NC}"
        CHECKS_FAILED=1
    else
        echo -e "${GREEN}âœ“ Flake8 passed${NC}"
    fi
else
    echo -e "${YELLOW}âš ï¸  Flake8 not found. Install with: pip install flake8${NC}"
fi

# Run black check if available
if command -v black &> /dev/null; then
    echo -e "\n${YELLOW}Running black format check...${NC}"
    echo "$PYTHON_FILES" | xargs black --check --line-length=120 --exclude=migrations
    if [ $? -ne 0 ]; then
        echo -e "${RED}âŒ Black found formatting issues. Run 'black .' to fix${NC}"
        CHECKS_FAILED=1
    else
        echo -e "${GREEN}âœ“ Black formatting check passed${NC}"
    fi
else
    echo -e "${YELLOW}âš ï¸  Black not found. Install with: pip install black${NC}"
fi

# Run isort check if available
if command -v isort &> /dev/null; then
    echo -e "\n${YELLOW}Running isort import check...${NC}"
    echo "$PYTHON_FILES" | xargs isort --check-only --profile=black --line-length=120 --skip=migrations
    if [ $? -ne 0 ]; then
        echo -e "${RED}âŒ Isort found import sorting issues. Run 'isort .' to fix${NC}"
        CHECKS_FAILED=1
    else
        echo -e "${GREEN}âœ“ Isort check passed${NC}"
    fi
else
    echo -e "${YELLOW}âš ï¸  Isort not found. Install with: pip install isort${NC}"
fi

# Check for common issues
echo -e "\n${YELLOW}Checking for common issues...${NC}"

# Check for debugger statements
if echo "$PYTHON_FILES" | xargs grep -n "import pdb\|pdb.set_trace()\|breakpoint()" 2>/dev/null; then
    echo -e "${RED}âŒ Found debugger statements (pdb/breakpoint)${NC}"
    CHECKS_FAILED=1
fi

# Check for print statements (warning only)
if echo "$PYTHON_FILES" | xargs grep -n "print(" 2>/dev/null; then
    echo -e "${YELLOW}âš ï¸  Found print() statements. Consider using logging instead${NC}"
fi

# Final result
echo ""
if [ $CHECKS_FAILED -eq 1 ]; then
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}âŒ Pre-push checks failed!${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${YELLOW}Fix the errors above before pushing.${NC}"
    echo -e "${YELLOW}Or use 'git push --no-verify' to skip checks (not recommended)${NC}"
    exit 1
else
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}âœ“ All pre-push checks passed!${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    exit 0
fi

